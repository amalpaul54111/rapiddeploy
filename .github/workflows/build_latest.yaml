name: Build latest images

on:
  push:
    branches:
      - main
    tags:
      - "v*"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Docker meta
      #   id: meta
      #   uses: docker/metadata-action@v4

      - name: Clone custom apps
        run: ./ci/clone-apps.sh
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          PYTHONPEN_GITHUB_PASSWORD: ${{ secrets.PYTHONPEN_GITHUB_PASSWORD }}

      - name: Setup QEMU
        uses: docker/setup-qemu-action@v2
        with:
          image: tonistiigi/binfmt:latest
          platforms: all

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v2

      - name: Docker meta
        id: docker_meta
        uses: docker/metadata-action@v3
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Base Versions
        id: get-base-versions
        run: |
          echo "::set-output name=FRAPPE_VERSION::$(jq -r .frappe base_versions.json)"
          echo "::set-output name=ERPNEXT_VERSION::$(jq -r .erpnext base_versions.json)"

      - name: Get Repo
        id: get-repo
        run: echo "::set-output name=REPOSITORY::${GITHUB_REPOSITORY#*/}"

      - name: Build and Push
        uses: docker/bake-action@v2.3.0
        with:
          push: true
          no-cache: true
          # set: "*.platform=linux/amd64,linux/arm64"
          # set: |
          #   *.tags=${{ steps.meta.outputs.tags }}
          #   *.labels=${{ steps.meta.outputs.labels }}
          #   *.platform=linux/amd64,linux/arm64
        env:
          FRAPPE_VERSION: ${{ steps.get-base-versions.outputs.FRAPPE_VERSION }}
          ERPNEXT_VERSION: ${{ steps.get-base-versions.outputs.ERPNEXT_VERSION }}
          REGISTRY_NAME: ghcr.io/${{ github.repository_owner }}
          VERSION: ${{  github.ref_name }}
          BACKEND_IMAGE_NAME: ${{ steps.get-repo.outputs.REPOSITORY }}/worker
          FRONTEND_IMAGE_NAME: ${{ steps.get-repo.outputs.REPOSITORY }}/nginx
          SOCKETIO_IMAGE_NAME: ${{ steps.get-repo.outputs.REPOSITORY }}/socketio

      - name: Fetch tacten-deploy repo
        uses: actions/checkout@v2
        with:
          repository: medblocks/tacten-deploy
          persist-credentials: false
          fetch-depth: 0
          token: ${{ secrets.NEUTRALBOY_GHSECRET }}

      - name: Update the mainfest
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          cat apps/kustomization.template.yaml | sed -e "s@NEW_TAG@${{  github.ref_name }}@g" | tee apps/kustomization.yaml
          git config --global user.email "leopoorna99@gmail.com"
          git config --global user.name "neutralboy"
          git add .
          git commit -m "Tagged new erpnext ${{  github.ref_name }}"
      # - name: Push to tacten-deploy
      #   if: startsWith(github.ref, 'refs/tags/v')
      #   uses: ad-m/github-push-action@master
      #   with:
      #     github_token: ${{ secrets.NEUTRALBOY_GHSECRET }}
      #     repository: medblocks/tacten-deploy
